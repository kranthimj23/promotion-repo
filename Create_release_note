pipeline {
    agent any
    
    environment {
        PYTHON_EXEC = 'python3.11'
        GIT_CREDENTIALS_ID = credentials('Jenkins-token-2')
        WORKSPACE_DIR = "${WORKSPACE}"
        SCRIPTS_DIR = "${WORKSPACE}/zdt-manager-src/backend/app/cd/scripts"
        INFRA_SCRIPTS_DIR = "${WORKSPACE}/zdt-manager-src/backend/infra/cd/scripts"
    }

    stages {
        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "Installing Python dependencies..."
                    python3.11 -m pip install openpyxl --user
                '''
            }
        }

        stage('Checkout with credentials') {
            steps {
                deleteDir()
                script {
                    withCredentials([string(credentialsId: 'Jenkins-token-2', variable: 'GIT_TOKEN')]) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/main"]],
                            userRemoteConfigs: [[
                                url: "${env.github_url}",
                                credentialsId: 'Jenkins-token-2'
                            ]]
                        ])
                        
                        // Configure git
                        sh '''
                            git config user.email "jenkins@example.com"
                            git config user.name "Jenkins CI"
                        '''
                    }
                }
            }
        }

        stage('Checkout zdt-manager-src repo') {
            steps {
                dir('zdt-manager-src') {
                    script {
                        withCredentials([string(credentialsId: 'Jenkins-token-2', variable: 'GIT_TOKEN')]) {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "*/zdt-application"]],
                                userRemoteConfigs: [[
                                    url: "https://${GIT_TOKEN}@github.com/kranthimj23/zdt-manager-src.git"
                                ]]
                            ])
                            
                            sh '''
                                git config user.email "jenkins@example.com"
                                git config user.name "Jenkins CI"
                            '''
                        }
                    }
                }
            }
        }

        stage('Load and Run merger.py') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'Jenkins-token-2', variable: 'GIT_TOKEN')]) {
                        sh '''
                            echo "Running merger.py script..."
                            cd ${WORKSPACE_DIR}
                            ${PYTHON_EXEC} ${SCRIPTS_DIR}/merger.py ${env.lower_env} ${env.higher_env} ${env.github_url} ${env.new_version}
                        '''

                        echo "Wait time of 5 secs"
                        sleep time: 5, unit: 'SECONDS'

                        // Parse the output from merger.py
                        def result = sh(
                            script: '''
                                cd ${WORKSPACE_DIR}
                                ${PYTHON_EXEC} ${SCRIPTS_DIR}/merger.py ${env.lower_env} ${env.higher_env} ${env.github_url} ${env.new_version}
                            ''',
                            returnStdout: true
                        ).trim()

                        def parts = result.tokenize(',')
                        env.X1_BRANCH = parts.size() > 0 ? parts[0]?.trim() : ''
                        env.X2_BRANCH = parts.size() > 1 ? parts[1]?.trim() : ''
                        env.LOWER_ENV = parts.size() > 2 ? parts[2]?.trim() : env.lower_env
                        env.HIGHER_ENV = parts.size() > 3 ? parts[3]?.trim() : env.higher_env
                        env.NEW_BRANCH = parts.size() > 4 ? parts[4]?.trim()?.toLowerCase() : 'false'
                        
                        echo "Parsed branches: X1=${env.X1_BRANCH}, X2=${env.X2_BRANCH}, NEW_BRANCH=${env.NEW_BRANCH}"
                    }
                }
            }
        }

        stage('Trigger Push-Files-To-Branch') {
            steps {
                script {
                    if (env.NEW_BRANCH == 'true') {
                        echo "Triggering Push-Files-To-Branch job for new branch: ${env.X2_BRANCH}"

                        withCredentials([string(credentialsId: 'Jenkins-token-2', variable: 'GIT_TOKEN')]) {
                            sh '''
                                echo "Running values-promotion.py script..."
                                cd ${WORKSPACE_DIR}
                                ${PYTHON_EXEC} ${SCRIPTS_DIR}/values-promotion.py ${env.github_url} ${env.X2_BRANCH}
                            '''
                        }
                    } else {
                        echo "Skipping Push-Files-To-Branch because NEW_BRANCH is not 'true'. Got: '${env.NEW_BRANCH}'"
                    }
                }
            }
        }

        stage('Generate release-note for Application, DB and Infra') {
            steps {
                script {
                    if (env.X1_BRANCH && env.X2_BRANCH) {
                        withCredentials([string(credentialsId: 'Jenkins-token-2', variable: 'GIT_TOKEN')]) {
                            sh '''
                                echo "Preparing release notes generation..."
                                cd ${WORKSPACE_DIR}
                                
                                # Make scripts executable
                                chmod +x ${SCRIPTS_DIR}/database_scripts_merger.py
                                
                                # Clean up generate-config directory if it exists as a file
                                if [ -f "generate-config" ]; then
                                    echo "Removing file: generate-config"
                                    rm -f generate-config
                                fi
                                
                                # Create clean generate-config directory
                                rm -rf generate-config
                                mkdir -p generate-config
                                
                                echo "Running create-release-note.py with:"
                                echo "  X1_BRANCH: ${X1_BRANCH}"
                                echo "  X2_BRANCH: ${X2_BRANCH}"
                                echo "  LOWER_ENV: ${LOWER_ENV}"
                                echo "  HIGHER_ENV: ${HIGHER_ENV}"
                                echo "  GITHUB_URL: ${github_url}"
                                
                                ${PYTHON_EXEC} ${SCRIPTS_DIR}/create-release-note.py \
                                    ${X1_BRANCH} \
                                    ${X2_BRANCH} \
                                    ${LOWER_ENV} \
                                    ${HIGHER_ENV} \
                                    ${github_url} \
                                    ${SCRIPTS_DIR}/database_scripts_merger.py
                            '''
                        }
                    } else {
                        echo "Skipping release note generation because required branches are missing."
                        echo "X1_BRANCH: ${env.X1_BRANCH}, X2_BRANCH: ${env.X2_BRANCH}"
                    }
                }
            }
        }

        // Optional: Uncomment if you want to run drift check
        // stage('Run Drift Check') {
        //     steps {
        //         script {
        //             if (env.X1_BRANCH && env.X2_BRANCH) {
        //                 withCredentials([string(credentialsId: 'Jenkins-token-2', variable: 'GIT_TOKEN')]) {
        //                     sh '''
        //                         echo "Running drift check..."
        //                         cd ${WORKSPACE_DIR}
        //                         ${PYTHON_EXEC} ${INFRA_SCRIPTS_DIR}/drift_lower_env.py \
        //                             ${github_url} \
        //                             ${X1_BRANCH} \
        //                             ${X2_BRANCH} \
        //                             ${LOWER_ENV} \
        //                             ${HIGHER_ENV}
        //                     '''
        //                 }
        //             }
        //         }
        //     }
        // }
    }

    post {
        always {
            echo "Cleaning up workspace..."
            // Optionally clean workspace after build
            // cleanWs()
        }
        success {
            echo "✓ Pipeline executed successfully!"
        }
        failure {
            echo "✗ Pipeline failed. Check console output above for details."
        }
    }
}
