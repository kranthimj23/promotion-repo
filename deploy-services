
pipeline {
    agent any

    environment {
        PYTHON_EXEC = 'python3.11'
        GIT_CREDENTIALS_ID = 'git-token-1'
        PROJECT_ID = 'mobile-app-1-482109'
        CLUSTER = 'autopilot-cluster-1'
        ZONE = 'us-central1'
    }

    options {
        skipDefaultCheckout()
    }

    stages {

        stage('Checkout promotion-repo') {
            steps {
                deleteDir()
                script {
                    withCredentials([string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')]) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${env.promotion_branch_x}"]],
                            userRemoteConfigs: [[
                                url: "https://${GIT_TOKEN}@github.com/kranthimj23/promotion-repo.git",
                                credentialsId: env.GIT_CREDENTIALS_ID
                            ]]
                        ])
                    }
                }
            }
        }

        stage('Checkout zdt-manager-src repo') {
            steps {
                dir('zdt-manager-src') {
                    script {
                        withCredentials([string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')]) {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "*/zdt-application"]],
                                userRemoteConfigs: [[
                                    url: "https://${GIT_TOKEN}@github.com/kranthimj23/zdt-manager-src.git"
                                ]]
                            ])
                        }
                    }
                }
            }
        }


       

        stage('Deploy') {
            when {
                expression { currentBuild.currentResult == 'SUCCESS' }
            }
                steps {
                    script {
                        withCredentials([
                            string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')
                        ]) {
                        
                        def deployScriptPath = "${WORKSPACE}/zdt-manager-src/backend/app/cd/scripts/deploy.py"
                        def deployNamespace = env.higher_env
                        def deployRepoUrl = env.github_url
                        def deployBranch = env.promotion_branch_x
            
                        echo "Deploying with env_namespace=${deployNamespace}, repo_url=${deployRepoUrl}, branch=${deployBranch}"
            
                        sh """
                            gcloud container clusters get-credentials ${CLUSTER} --zone ${ZONE} --project ${PROJECT_ID}
                            ${PYTHON_EXEC} ${deployScriptPath} ${deployNamespace} ${deployRepoUrl} ${deployBranch}
                        """
                    }
                }
            }
        }

      
    }
}
