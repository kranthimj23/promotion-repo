
pipeline {
    agent any

    environment {
        PYTHON_EXEC = 'python3.11'
        GIT_CREDENTIALS_ID = 'jenkins-token'
        PROJECT_ID = 'nice-virtue-463917-m0'
        CLUSTER = 'autopilot-cluster-1'
        ZONE = 'asia-southeast1'
    }

    options {
        skipDefaultCheckout()
    }

    stages {

        stage('Checkout promotion-repo') {
            steps {
                deleteDir()
                script {
                    withCredentials([string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')]) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${env.promotion_branch_x}"]],
                            userRemoteConfigs: [[
                                url: "https://${GIT_TOKEN}@github.com/kranthimj23/promotion-repo.git",
                                credentialsId: env.GIT_CREDENTIALS_ID
                            ]]
                        ])
                    }
                }
            }
        }

        stage('Checkout zdt-manager-src repo') {
            steps {
                dir('zdt-manager-src') {
                    script {
                        withCredentials([string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')]) {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "*/zdt-application"]],
                                userRemoteConfigs: [[
                                    url: "https://${GIT_TOKEN}@github.com/kranthimj23/zdt-manager-src.git"
                                ]]
                            ])
                        }
                    }
                }
            }
        }

        stage('Debug workspace contents') {
            steps {
                script {
                    echo "Listing workspace files recursively:"
                    sh 'ls -R'
                }
            }
        }

        stage('Check commits in release_note') {
            steps {
                script {
                    echo "Checking commits in folder: release_note"

                    if (!fileExists(".git")) {
                        error(".git directory missing — make sure repository checkout was successful.")
                    }

                    def commits = sh(
                        script: "git log -n 10 --pretty=format:\"%H|%s\" -- helm-charts/${env.higher_env}-values/app-values/release_note/*.xlsx",
                        returnStdout: true
                    ).trim()
                    echo commits

                    def pattern = ~("Verified RN in:" + env.promotion_branch_x)
                    def executePython = false

                    commits.split('\n').each { line ->
                        def parts = line.split('\\|', 2)
                        if (parts.length == 2) {
                            def commitMsg = parts[1]
                            echo "Checking commit message: ${commitMsg}"
                            if ((commitMsg =~ pattern).matches()) {
                                echo "Found matching commit message: ${commitMsg}"
                                executePython = true
                            }
                        }
                    }

                    env.EXECUTE_PYTHON = executePython.toString()
                }
            }
        }

        stage('Run Python scripts') {
            when {
                expression { return env.EXECUTE_PYTHON == 'true' }
            }
            steps {
                script {
                    withCredentials([
                        string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')
                    ]) {
                       // def driftPromotionPath = "${WORKSPACE}/zdt-manager-src/backend/infra/cd/scripts/drift_promotion.py"
                        def generateConfigPath = "${WORKSPACE}/zdt-manager-src/backend/app/cd/scripts/generate-config.py"

                        // Uncomment to run drift_promotion.py
                        /*
                        echo "Running: ${driftPromotionPath}"
                        def resultDrift = sh(
                            script: "${env.PYTHON_EXEC} ${driftPromotionPath} ${env.github_url} ${env.promotion_branch_x} ${env.higher_env}",
                            returnStdout: true
                        ).trim()
                        echo resultDrift
                        */

                        echo "Running: ${generateConfigPath}"
                        def resultGen = sh(
                            script: "${env.PYTHON_EXEC} ${generateConfigPath} ${env.github_url} ${env.promotion_branch_x_1} ${env.promotion_branch_x} ${env.lower_env} ${env.higher_env}",
                            returnStdout: true
                        ).trim()
                        echo resultGen

                        // def targetFile = "${WORKSPACE}/helm-charts/${env.higher_env}-values/db-scripts/AQL/${env.higher_env}.txt"
                        // if (fileExists(targetFile)) {
                        //     echo "File exists: ${targetFile}"

                        //     // ✅ Optional: ansible_sparse_execution_cd step
                        //     /*
                        //     build job: 'ansible_sparse_execution_cd',
                        //         parameters: [
                        //             string(name: 'higher_env', value: env.higher_env),
                        //             string(name: 'promotion_branch_x', value: env.promotion_branch_x)
                        //         ],
                        //         wait: true,
                        //         propagate: true
                        //     */
                        // } else {
                        //     echo "File does NOT exist: ${targetFile}"
                        // }

                        // ✅ Optional: downstream deploy job
                                            
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                expression { currentBuild.currentResult == 'SUCCESS' }
            }
                steps {
                    script {
                        withCredentials([
                            string(credentialsId: env.GIT_CREDENTIALS_ID, variable: 'GIT_TOKEN')
                        ]) {
                            def deployScriptPath = "${WORKSPACE}/zdt-manager-src/backend/app/cd/scripts/deploy.py"
                        def deployNamespace = env.higher_env
                        def deployRepoUrl = env.github_url
                        def deployBranch = env.promotion_branch_x
            
                        echo "Deploying with env_namespace=${deployNamespace}, repo_url=${deployRepoUrl}, branch=${deployBranch}"
            
                        sh """
                            gcloud container clusters get-credentials ${CLUSTER} --zone ${ZONE} --project ${PROJECT_ID}
                            ${PYTHON_EXEC} deployScriptPath ${deployNamespace} ${deployRepoUrl} ${deployBranch}
                        """
                    }
                }
            }
        }
    }
}
